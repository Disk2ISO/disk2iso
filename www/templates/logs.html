<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>disk2iso - Logs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1><img src="{{ url_for('static', filename='img/control.svg') }}" alt="" style="width:28px;height:28px;vertical-align:middle;margin-right:8px;">disk2iso</h1>
        </div>

        <div class="main-wrapper">
            <!-- Sidebar Navigation -->
            <aside class="sidebar">
                <nav>
                    <ul class="nav-menu">
                        <li>
                            <a href="/">
                                <span class="nav-icon"><img src="{{ url_for('static', filename='img/home.svg') }}" alt="Home"></span>
                                <span>Home</span>
                            </a>
                        </li>
                        <li>
                            <a href="/archive">
                                <span class="nav-icon"><img src="{{ url_for('static', filename='img/archive.svg') }}" alt="Archiv"></span>
                                <span>Archiv</span>
                            </a>
                        </li>
                        <li>
                            <a href="/logs" class="active">
                                <span class="nav-icon"><img src="{{ url_for('static', filename='img/logs.svg') }}" alt="Logs"></span>
                                <span>Logs</span>
                            </a>
                        </li>
                        <li>
                            <a href="/system">
                                <span class="nav-icon"><img src="{{ url_for('static', filename='img/system.svg') }}" alt="System"></span>
                                <span>System</span>
                            </a>
                        </li>
                        <li>
                            <a href="/config">
                                <span class="nav-icon"><img src="{{ url_for('static', filename='img/settings.svg') }}" alt="Konfiguration"></span>
                                <span>Konfiguration</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <!-- Breadcrumb -->
                <nav class="breadcrumb">
                    <ul class="breadcrumb-list">
                        <li>
                            <a href="/"><img src="{{ url_for('static', filename='img/home.svg') }}" alt="" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;">Home</a>
                        </li>
                        <li>
                            <span><img src="{{ url_for('static', filename='img/logs.svg') }}" alt="" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;">Logs</span>
                        </li>
                    </ul>
                </nav>

                <!-- Log Controls -->
                <div class="card">
                    <h2>Log Viewer</h2>
                    
                    <div class="log-controls">
                        <select id="log-type" onchange="loadLogs()">
                            <option value="current">Aktuelles Log</option>
                            <option value="system">System Log (journalctl)</option>
                            <option value="archived">Archivierte Logs</option>
                        </select>
                        
                        <select id="log-level">
                            <option value="all">Alle Level</option>
                            <option value="error">Nur Fehler</option>
                            <option value="warning">Warnungen + Fehler</option>
                            <option value="info">Info + Warnungen + Fehler</option>
                        </select>
                        
                        <input type="text" id="log-search" class="log-filter" placeholder="Logs filtern..." onkeyup="filterLogs()">
                        
                        <button onclick="loadLogs()"><img src="{{ url_for('static', filename='img/refresh.svg') }}" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:4px;">Aktualisieren</button>
                        <button class="btn-secondary" onclick="clearLogView()"><img src="{{ url_for('static', filename='img/trash.svg') }}" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:4px;">Ansicht leeren</button>
                        <button class="btn-secondary" onclick="downloadLog()"><img src="{{ url_for('static', filename='img/save.svg') }}" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:4px;">Download</button>
                        
                        <label class="auto-refresh-label">
                            <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()">
                            <span>Auto-Refresh (5s)</span>
                        </label>
                    </div>
                    
                    <div id="archived-logs-list" style="display: none;">
                        <h3>Verfügbare Log-Dateien:</h3>
                        <div class="log-file-list" id="log-files"></div>
                    </div>
                    
                    <div class="log-info" id="log-info">
                        <div class="log-info-item">
                            <span class="log-info-label">Log-Typ:</span>
                            <span class="log-info-value" id="current-log-type">Aktuelles Log</span>
                        </div>
                        <div class="log-info-item">
                            <span class="log-info-label">Zeilen:</span>
                            <span class="log-info-value" id="log-lines">0</span>
                        </div>
                        <div class="log-info-item">
                            <span class="log-info-label">Letzte Aktualisierung:</span>
                            <span class="log-info-value" id="last-update">-</span>
                        </div>
                    </div>
                    
                    <div class="log-viewer" id="log-viewer">
                        <pre id="log-content">Lade Logs...</pre>
                    </div>
                </div>

                <div class="footer">
                    <p>disk2iso - Automatische ISO Erstellung von optischen Medien</p>
                    <p style="margin-top: 5px; font-size: 0.9em;">© 2026 | Version {{ version }}</p>
                </div>
            </main>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/logs.js') }}"></script>
</body>
</html>
        
        // Lade Logs beim Start
        window.addEventListener('load', function() {
            loadLogs();
        });
        
        function loadLogs() {
            const logType = document.getElementById('log-type').value;
            const logContent = document.getElementById('log-content');
            const logInfo = document.getElementById('log-info');
            const archivedList = document.getElementById('archived-logs-list');
            
            // Update Log-Typ Anzeige
            document.getElementById('current-log-type').textContent = 
                document.getElementById('log-type').options[document.getElementById('log-type').selectedIndex].text;
            
            if (logType === 'archived') {
                // Zeige verfügbare Log-Dateien
                archivedList.style.display = 'block';
                loadArchivedLogFiles();
                logContent.textContent = 'Bitte wählen Sie eine Log-Datei aus der Liste oben.';
                return;
            } else {
                archivedList.style.display = 'none';
                currentLogFile = null;
            }
            
            logContent.textContent = 'Lade Logs...';
            
            let endpoint = '/api/logs/current';
            if (logType === 'system') {
                endpoint = '/api/logs/system';
            }
            
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLogs(data.logs, data.lines);
                        document.getElementById('last-update').textContent = new Date().toLocaleString('de-DE');
                    } else {
                        logContent.textContent = `Fehler: ${data.message || 'Unbekannter Fehler'}`;
                        document.getElementById('log-lines').textContent = '0';
                    }
                })
                .catch(error => {
                    logContent.textContent = `Fehler beim Laden der Logs: ${error}`;
                    console.error('Log-Fehler:', error);
                });
        }
        
        function loadArchivedLogFiles() {
            fetch('/api/logs/archived')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fileList = document.getElementById('log-files');
                        fileList.innerHTML = '';
                        
                        if (data.files.length === 0) {
                            fileList.innerHTML = '<div class="no-logs">Keine archivierten Logs verfügbar</div>';
                            return;
                        }
                        
                        data.files.forEach(file => {
                            const item = document.createElement('div');
                            item.className = 'log-file-item';
                            item.textContent = file.name;
                            item.title = `${file.size} Bytes - ${file.modified}`;
                            item.onclick = () => loadArchivedLog(file.name);
                            fileList.appendChild(item);
                        });
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Log-Dateien:', error);
                });
        }
        
        function loadArchivedLog(filename) {
            currentLogFile = filename;
            
            // Markiere aktive Datei
            document.querySelectorAll('.log-file-item').forEach(item => {
                if (item.textContent === filename) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            const logContent = document.getElementById('log-content');
            logContent.textContent = 'Lade Log-Datei...';
            
            fetch(`/api/logs/archived/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLogs(data.logs, data.lines);
                        document.getElementById('current-log-type').textContent = filename;
                        document.getElementById('last-update').textContent = new Date().toLocaleString('de-DE');
                    } else {
                        logContent.textContent = `Fehler: ${data.message || 'Unbekannter Fehler'}`;
                    }
                })
                .catch(error => {
                    logContent.textContent = `Fehler beim Laden der Log-Datei: ${error}`;
                    console.error('Log-Fehler:', error);
                });
        }
        
        function displayLogs(logs, lineCount) {
            const logContent = document.getElementById('log-content');
            document.getElementById('log-lines').textContent = lineCount || logs.split('\n').length;
            
            if (!logs || logs.trim() === '') {
                logContent.innerHTML = '<div class="no-logs">Keine Logs verfügbar</div>';
                return;
            }
            
            // Highlighte Log-Zeilen basierend auf Keywords
            const lines = logs.split('\n');
            const highlightedLines = lines.map(line => {
                let className = '';
                const lowerLine = line.toLowerCase();
                
                if (lowerLine.includes('error') || lowerLine.includes('fehler') || lowerLine.includes('failed')) {
                    className = 'log-line-error';
                } else if (lowerLine.includes('warning') || lowerLine.includes('warnung') || lowerLine.includes('warn')) {
                    className = 'log-line-warning';
                } else if (lowerLine.includes('success') || lowerLine.includes('erfolgreich') || lowerLine.includes('completed')) {
                    className = 'log-line-success';
                } else if (lowerLine.includes('info') || lowerLine.includes('start')) {
                    className = 'log-line-info';
                }
                
                return `<div class="log-line ${className}">${escapeHtml(line)}</div>`;
            });
            
            logContent.innerHTML = highlightedLines.join('');
            
            // Scrolle zum Ende
            const viewer = document.getElementById('log-viewer');
            viewer.scrollTop = viewer.scrollHeight;
            
            // Wende Filter an
            filterLogs();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function filterLogs() {
            const searchTerm = document.getElementById('log-search').value.toLowerCase();
            const logLevel = document.getElementById('log-level').value;
            const lines = document.querySelectorAll('.log-line');
            
            lines.forEach(line => {
                const text = line.textContent.toLowerCase();
                let showLine = true;
                
                // Filter nach Suchbegriff
                if (searchTerm && !text.includes(searchTerm)) {
                    showLine = false;
                }
                
                // Filter nach Log-Level
                if (showLine && logLevel !== 'all') {
                    const isError = line.classList.contains('log-line-error');
                    const isWarning = line.classList.contains('log-line-warning');
                    const isInfo = line.classList.contains('log-line-info');
                    
                    if (logLevel === 'error' && !isError) {
                        showLine = false;
                    } else if (logLevel === 'warning' && !isError && !isWarning) {
                        showLine = false;
                    } else if (logLevel === 'info' && !isError && !isWarning && !isInfo) {
                        showLine = false;
                    }
                }
                
                line.style.display = showLine ? '' : 'none';
            });
        }
        
        function clearLogView() {
            document.getElementById('log-content').innerHTML = '<div class="no-logs">Ansicht geleert. Klicken Sie auf "Aktualisieren" um Logs zu laden.</div>';
            document.getElementById('log-lines').textContent = '0';
        }
        
        function downloadLog() {
            const logType = document.getElementById('log-type').value;
            const logContent = document.getElementById('log-content').textContent;
            
            if (!logContent || logContent.includes('Keine Logs')) {
                alert('Keine Logs zum Download verfügbar');
                return;
            }
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            let filename = `disk2iso_${logType}_${timestamp}.log`;
            if (currentLogFile) {
                filename = currentLogFile;
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        function toggleAutoRefresh() {
            const enabled = document.getElementById('auto-refresh').checked;
            
            if (enabled) {
                autoRefreshInterval = setInterval(loadLogs, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        // Cleanup bei Seitenwechsel

