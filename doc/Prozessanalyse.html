<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>disk2iso Prozessanalyse - Workflow-Ablauf</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #2980b9;
        }
        td {
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        .phase-header {
            background-color: #34495e;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }
        .state {
            background-color: #ecf0f1;
            font-weight: bold;
            text-align: center;
        }
        .audio-cd {
            background-color: #e8f5e9;
        }
        .dvd-video {
            background-color: #e3f2fd;
        }
        .bd-video {
            background-color: #f3e5f5;
        }
        .data-disc {
            background-color: #fff3e0;
        }
        .metadata-0 {
            background-color: #ffebee;
        }
        .metadata-1 {
            background-color: #e8f5e9;
        }
        .metadata-many {
            background-color: #fff9c4;
        }
        .step {
            margin: 5px 0;
        }
        .step-number {
            font-weight: bold;
            color: #2980b9;
        }
        .duration {
            color: #7f8c8d;
            font-style: italic;
            font-size: 0.9em;
        }
        .critical {
            color: #c0392b;
            font-weight: bold;
        }
        .optional {
            color: #27ae60;
        }
        .legend {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-left: 4px solid #3498db;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
            padding: 5px 10px;
        }
        .note {
            background-color: #fff9c4;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #fbc02d;
        }
        .arrow {
            text-align: center;
            font-size: 1.5em;
            color: #3498db;
        }
        .output-files {
            background-color: #f0f4f8;
            padding: 8px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>disk2iso Prozessanalyse - Kompletter Workflow-Ablauf</h1>
    
    <div class="legend">
        <h3>Legende</h3>
        <span class="legend-item audio-cd">Audio-CD</span>
        <span class="legend-item dvd-video">DVD-Video</span>
        <span class="legend-item bd-video">Blu-ray Video</span>
        <span class="legend-item data-disc">Daten-Disc</span>
        <span class="legend-item metadata-0">0 Releases</span>
        <span class="legend-item metadata-1">1 Release</span>
        <span class="legend-item metadata-many">Mehrere Releases</span>
    </div>

    <h2>Hauptprozess-Tabelle</h2>
    
    <table>
        <thead>
            <tr>
                <th>Phase</th>
                <th>State</th>
                <th colspan="6">Ablauf / Verzweigungen</th>
            </tr>
        </thead>
        <tbody>
            <!-- PHASE 0: INITIALISIERUNG -->
            <tr>
                <td class="phase-header" rowspan="3">Phase 0<br>Initialisierung</td>
                <td class="state">INITIALIZING</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">1.</span> System-Prüfung</div>
                    <div class="step"><span class="step-number">2.</span> Module laden (libconfig, liblogging, libfolders, libapi, libintegrity, libdiskinfos, libdrivestat)</div>
                    <div class="step"><span class="step-number">3.</span> Core-Abhängigkeiten prüfen</div>
                    <div class="duration">Dauer: 1-2 Sekunden</div>
                </td>
            </tr>
            <tr>
                <td class="state">WAITING_FOR_DRIVE</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">4.</span> Suche nach optischem Laufwerk (detect_device)</div>
                    <div class="step"><span class="step-number">5.</span> Polling-Intervall: 20 Sekunden</div>
                    <div class="duration">Dauer: Bis Laufwerk erkannt</div>
                </td>
            </tr>
            <tr>
                <td class="state">DRIVE_DETECTED</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">6.</span> Laufwerk-Bereitschaft prüfen (ensure_device_ready)</div>
                    <div class="step"><span class="step-number">7.</span> System-Informationen sammeln (collect_system_information)</div>
                    <div class="duration">Dauer: 1-2 Sekunden</div>
                </td>
            </tr>

            <!-- PHASE 1: MEDIEN-ERKENNUNG -->
            <tr>
                <td class="phase-header" rowspan="3">Phase 1<br>Medien-Erkennung</td>
                <td class="state">WAITING_FOR_MEDIA</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">8.</span> Prüfe ob Medium eingelegt (is_disc_inserted)</div>
                    <div class="step"><span class="step-number">9.</span> Polling-Intervall: 2 Sekunden</div>
                    <div class="duration">Dauer: Bis Medium erkannt</div>
                </td>
            </tr>
            <tr>
                <td class="state">MEDIA_DETECTED</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">10.</span> Warte auf Disc-Bereitschaft (Spin-Up)</div>
                    <div class="step"><span class="step-number">11.</span> wait_for_disc_ready (max 3 Versuche)</div>
                    <div class="duration">Dauer: 2-5 Sekunden</div>
                </td>
            </tr>
            <tr>
                <td class="state">ANALYZING</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">12.</span> <span class="critical">detect_disc_type()</span> - Disc-Typ erkennen</div>
                    <div class="step">└─ <b>Methode 1:</b> blkid (Dateisystem-Typ)</div>
                    <div class="step">└─ <b>Methode 2:</b> isoinfo -d (ISO9660 Prüfung)</div>
                    <div class="step">└─ <b>Methode 3:</b> isoinfo -l (Verzeichnis-Struktur: /VIDEO_TS, /BDMV)</div>
                    <div class="step">└─ <b>Methode 4:</b> mount -o ro (Temporäres Mounten)</div>
                    <div class="step">└─ <b>Methode 5:</b> Disc-Größe (CD < 900 MB, DVD < 9 GB, BD > 9 GB)</div>
                    <div class="step"><span class="step-number">13.</span> get_disc_label() - Volume-Label extrahieren (außer Audio-CD)</div>
                    <div class="step"><span class="step-number">14.</span> Unmount falls auto-gemountet</div>
                    <div class="duration">Dauer: 5-15 Sekunden</div>
                </td>
            </tr>

            <!-- VERZWEIGUNG: DISC-TYP -->
            <tr>
                <td class="phase-header" colspan="2">Disc-Typ Verzweigung</td>
                <th class="audio-cd">Audio-CD</th>
                <th class="dvd-video">DVD-Video</th>
                <th class="bd-video">Blu-ray Video</th>
                <th class="data-disc" colspan="3">Daten-Disc (CD/DVD/BD-ROM)</th>
            </tr>

            <!-- PHASE 2: METADATA (nur Audio-CD, DVD-Video, BD-Video) -->
            <tr>
                <td class="phase-header" rowspan="6">Phase 2<br>Metadata-Abfrage<br>(optional)</td>
                <td class="state">ANALYZING<br>(Metadata)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">15a.</span> <b>MusicBrainz Query</b></div>
                    <div class="step">└─ cd-discid: Disc-ID + TOC</div>
                    <div class="step">└─ cdparanoia -Q: Leadout</div>
                    <div class="step">└─ TOC: 1+tracks+leadout+offsets</div>
                    <div class="step">└─ API: GET /ws/2/discid/{id}?toc={toc}</div>
                    <div class="duration">Dauer: 5-10 Sekunden</div>
                </td>
                <td class="dvd-video">
                    <div class="step"><span class="step-number">15b.</span> <b>TMDB Query</b></div>
                    <div class="step">└─ Nutzt disc_label als Suche</div>
                    <div class="step">└─ API: GET /search/movie?query={label}</div>
                    <div class="duration">Dauer: 5-10 Sekunden</div>
                </td>
                <td class="bd-video">
                    <div class="step"><span class="step-number">15c.</span> <b>TMDB Query</b></div>
                    <div class="step">└─ Nutzt disc_label als Suche</div>
                    <div class="step">└─ API: GET /search/movie?query={label}</div>
                    <div class="duration">Dauer: 5-10 Sekunden</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="step"><span class="step-number">15d.</span> <b>Keine Metadata</b></div>
                    <div class="step">└─ Nutzt disc_label aus ISO9660</div>
                    <div class="step">└─ Direkt zu Phase 3</div>
                </td>
            </tr>

            <!-- VERZWEIGUNG: ANZAHL RELEASES -->
            <tr>
                <td class="state">Releases<br>Verzweigung</td>
                <td class="audio-cd" colspan="3">
                    <div class="step"><span class="step-number">16.</span> Prüfe releases.length</div>
                </td>
                <td class="data-disc" colspan="3" rowspan="5">
                    <div class="step"><b>Keine Metadata-Phase</b></div>
                    <div class="step">└─ Überspringe zu Phase 3</div>
                </td>
            </tr>
            <tr>
                <td class="state">0 Releases</td>
                <td class="metadata-0">
                    <div class="step"><span class="step-number">17a.</span> <b>Keine Treffer</b></div>
                    <div class="step">└─ Verwende generische Namen</div>
                    <div class="step">└─ audio_cd_{discid}</div>
                    <div class="step">└─ skip_metadata = true</div>
                    <div class="duration">Direkt zu Phase 3</div>
                </td>
                <td class="metadata-0" colspan="2">
                    <div class="step"><span class="step-number">17b.</span> <b>Keine Treffer</b></div>
                    <div class="step">└─ Verwende disc_label</div>
                    <div class="step">└─ Direkt zu Phase 3</div>
                </td>
            </tr>
            <tr>
                <td class="state">1 Release</td>
                <td class="metadata-1">
                    <div class="step"><span class="step-number">18a.</span> <b>Genau 1 Treffer</b></div>
                    <div class="step">└─ Direktverwendung (kein User-Input)</div>
                    <div class="step">└─ cd_artist = releases[0].artist</div>
                    <div class="step">└─ cd_album = releases[0].title</div>
                    <div class="step">└─ cd_year = releases[0].date</div>
                    <div class="step">└─ disc_label = {artist}_{album}</div>
                    <div class="duration">Direkt zu Phase 3</div>
                </td>
                <td class="metadata-1" colspan="2">
                    <div class="step"><span class="step-number">18b.</span> <b>Genau 1 Treffer</b></div>
                    <div class="step">└─ Direktverwendung</div>
                    <div class="step">└─ disc_label = {title}_{year}</div>
                    <div class="duration">Direkt zu Phase 3</div>
                </td>
            </tr>
            <tr>
                <td class="state">Mehrere<br>Releases</td>
                <td class="metadata-many">
                    <div class="step"><span class="step-number">19a.</span> <b>Mehrere Treffer</b></div>
                    <div class="step">└─ Erstelle musicbrainz_releases.json</div>
                    <div class="step">└─ Setze Status: waiting_user_input</div>
                    <div class="step">└─ API-Update: WAITING_FOR_METADATA</div>
                </td>
                <td class="metadata-many" colspan="2">
                    <div class="step"><span class="step-number">19b.</span> <b>Mehrere Treffer</b></div>
                    <div class="step">└─ Erstelle tmdb_results.json</div>
                    <div class="step">└─ Setze Status: waiting_user_input</div>
                    <div class="step">└─ API-Update: WAITING_FOR_METADATA</div>
                </td>
            </tr>
            <tr>
                <td class="state">WAITING_FOR_<br>METADATA</td>
                <td class="metadata-many">
                    <div class="step"><span class="step-number">20a.</span> <b>wait_for_metadata_selection()</b></div>
                    <div class="step">└─ Schreibe .mbquery Datei</div>
                    <div class="step">└─ Warte auf .mbselect (Timeout: 60s)</div>
                    <div class="step">└─ Polling-Intervall: 1 Sekunde</div>
                    <div class="step">└─ <b>Bei Timeout:</b> Generische Namen</div>
                    <div class="step">└─ <b>Bei Auswahl:</b> cd_artist/album/year gesetzt</div>
                    <div class="duration">Dauer: 0-60 Sekunden</div>
                </td>
                <td class="metadata-many" colspan="2">
                    <div class="step"><span class="step-number">20b.</span> <b>wait_for_tmdb_selection()</b></div>
                    <div class="step">└─ Schreibe .tmdbquery Datei</div>
                    <div class="step">└─ Warte auf .tmdbselect (Timeout: 60s)</div>
                    <div class="step">└─ Polling-Intervall: 1 Sekunde</div>
                    <div class="step">└─ <b>Bei Timeout:</b> disc_label verwenden</div>
                    <div class="step">└─ <b>Bei Auswahl:</b> Metadaten gesetzt</div>
                    <div class="duration">Dauer: 0-60 Sekunden</div>
                </td>
            </tr>

            <!-- PHASE 3: KOPIERVORGANG -->
            <tr>
                <td class="phase-header" rowspan="8">Phase 3<br>Kopiervorgang</td>
                <td class="state">COPYING<br>(Vorbereitung)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">21a.</span> <b>Temp-Verzeichnis</b></div>
                    <div class="step">└─ Mit Metadata: /tmp/{artist}/{album}/</div>
                    <div class="step">└─ Ohne Metadata: /tmp/audio_cd_{discid}/</div>
                    <div class="step"><span class="step-number">22a.</span> <b>Track-Anzahl ermitteln</b></div>
                    <div class="step">└─ cdparanoia -Q | grep "^\s+[0-9]+"</div>
                    <div class="step">└─ track_count für Progress-API</div>
                    <div class="step"><span class="step-number">23a.</span> <b>Cover-Download</b></div>
                    <div class="step">└─ Falls mb_response verfügbar</div>
                    <div class="step">└─ coverartarchive.org/release/{id}/front</div>
                </td>
                <td class="dvd-video">
                    <div class="step"><span class="step-number">21b.</span> <b>init_filenames()</b></div>
                    <div class="step">└─ iso_filename = {disc_label}.iso</div>
                    <div class="step">└─ md5_filename = {disc_label}.md5</div>
                    <div class="step">└─ log_filename = {disc_label}.log</div>
                    <div class="step"><span class="step-number">22b.</span> <b>Speicherplatz prüfen</b></div>
                    <div class="step">└─ check_disk_space (ca. 9 GB)</div>
                </td>
                <td class="bd-video">
                    <div class="step"><span class="step-number">21c.</span> <b>init_filenames()</b></div>
                    <div class="step">└─ iso_filename = {disc_label}.iso</div>
                    <div class="step">└─ md5_filename = {disc_label}.md5</div>
                    <div class="step">└─ log_filename = {disc_label}.log</div>
                    <div class="step"><span class="step-number">22c.</span> <b>Speicherplatz prüfen</b></div>
                    <div class="step">└─ check_disk_space (ca. 25-50 GB)</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="step"><span class="step-number">21d.</span> <b>init_filenames()</b></div>
                    <div class="step">└─ iso_filename = {disc_label}.iso</div>
                    <div class="step">└─ md5_filename = {disc_label}.md5</div>
                    <div class="step">└─ log_filename = {disc_label}.log</div>
                    <div class="step"><span class="step-number">22d.</span> <b>Speicherplatz prüfen</b></div>
                    <div class="step">└─ check_disk_space (disc-size abhängig)</div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(Haupt-Prozess)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">24a.</span> <b>Track-Ripping Loop</b></div>
                    <div class="step">└─ for track in 1..track_count:</div>
                    <div class="step">&nbsp;&nbsp;&nbsp;&nbsp;<b>1.</b> cdparanoia: WAV rippen</div>
                    <div class="step">&nbsp;&nbsp;&nbsp;&nbsp;<b>2.</b> lame: MP3 encoding (VBR V2)</div>
                    <div class="step">&nbsp;&nbsp;&nbsp;&nbsp;<b>3.</b> ID3-Tags setzen (artist, album, year, title, track#)</div>
                    <div class="step">&nbsp;&nbsp;&nbsp;&nbsp;<b>4.</b> eyeD3: Cover einbetten</div>
                    <div class="step">&nbsp;&nbsp;&nbsp;&nbsp;<b>5.</b> WAV löschen (Speicherplatz)</div>
                    <div class="step">&nbsp;&nbsp;&nbsp;&nbsp;<b>6.</b> Progress: track/track_count</div>
                    <div class="step"><b>Dateinamen:</b></div>
                    <div class="step">└─ Mit Metadata: "Artist - Title.mp3"</div>
                    <div class="step">└─ Ohne Metadata: "Track 01.mp3"</div>
                    <div class="duration">Dauer: 40-60 Minuten (12 Tracks)</div>
                </td>
                <td class="dvd-video">
                    <div class="step"><span class="step-number">24b.</span> <b>dvdbackup</b></div>
                    <div class="step">└─ dvdbackup -i {device} -o /tmp/dvd -M</div>
                    <div class="step">└─ Entschlüsselt CSS (benötigt libdvdcss)</div>
                    <div class="step">└─ Kopiert VIDEO_TS/ nach /tmp</div>
                    <div class="step"><span class="step-number">25b.</span> <b>genisoimage</b></div>
                    <div class="step">└─ genisoimage -dvd-video -udf -o {iso} /tmp/dvd/*/</div>
                    <div class="step">└─ Erstellt ISO aus VIDEO_TS/</div>
                    <div class="duration">Dauer: 15-30 Minuten</div>
                </td>
                <td class="bd-video">
                    <div class="step"><span class="step-number">24c.</span> <b>ddrescue</b></div>
                    <div class="step">└─ ddrescue -n -b 2048 {device} {iso} /tmp/ddrescue.log</div>
                    <div class="step">└─ Bit-für-Bit Kopie</div>
                    <div class="step">└─ Robustes Skip bei Lesefehlern</div>
                    <div class="step">└─ Progress-Log in /tmp/ddrescue.log</div>
                    <div class="duration">Dauer: 30-90 Minuten</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="step"><span class="step-number">24d.</span> <b>ddrescue oder dd</b></div>
                    <div class="step">└─ Bevorzugt: ddrescue -n -b 2048</div>
                    <div class="step">└─ Fallback: dd if={device} of={iso} bs=2048</div>
                    <div class="step">└─ Bit-für-Bit Kopie</div>
                    <div class="duration">Dauer: 5-20 Minuten</div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(Nachbearbeitung)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">25a.</span> <b>Cover kopieren</b></div>
                    <div class="step">└─ cp cover.jpg {album_dir}/folder.jpg</div>
                    <div class="step"><span class="step-number">26a.</span> <b>album.nfo erstellen</b></div>
                    <div class="step">└─ Via metadb_export_nfo() (Jellyfin XML)</div>
                    <div class="step">└─ Nur bei vorhandenen Metadaten</div>
                </td>
                <td class="dvd-video" colspan="2">
                    <div class="step"><span class="step-number">25b.</span> <b>Cleanup</b></div>
                    <div class="step">└─ rm -rf /tmp/dvd_$$</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="step"><span class="step-number">25c.</span> <b>Validierung</b></div>
                    <div class="step">└─ Prüfe ISO-Größe > 0</div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(ISO-Erstellung)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">27a.</span> <b>genisoimage</b></div>
                    <div class="step">└─ Volume-ID: Album-Name oder AUDIO_CD_{discid}</div>
                    <div class="step">└─ genisoimage -R -J -joliet-long -V "{volume_id}" -o {iso} /tmp/artist/album/</div>
                    <div class="step"><b>ISO-Struktur:</b></div>
                    <div class="step">└─ /Artist Name/Album Title/Artist - Track 01.mp3</div>
                    <div class="step">└─ /Artist Name/Album Title/folder.jpg</div>
                    <div class="step">└─ /Artist Name/Album Title/album.nfo</div>
                    <div class="duration">Dauer: 30 Sekunden - 2 Minuten</div>
                </td>
                <td class="dvd-video" colspan="2">
                    <div class="note">ISO bereits in Schritt 25b erstellt</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="note">ISO bereits in Schritt 24d erstellt</div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(Checksumme)</td>
                <td class="audio-cd" colspan="6">
                    <div class="step"><span class="step-number">28.</span> <b>MD5-Checksumme erstellen</b></div>
                    <div class="step">└─ md5sum {iso} > {md5}</div>
                    <div class="duration">Dauer: 30 Sekunden - 3 Minuten (ISO-Größe abhängig)</div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(Archiv-Metadata)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">29a.</span> <b>create_archive_metadata()</b></div>
                    <div class="step">└─ {disc_label}.nfo (Einfaches Format)</div>
                    <div class="step">└─ {disc_label}-thumb.jpg (Cover-Thumbnail)</div>
                    <div class="step"><b>NFO-Inhalt:</b></div>
                    <div class="step">└─ TITLE, ARTIST, DATE, COUNTRY, TRACKS, DURATION, TYPE</div>
                </td>
                <td class="dvd-video" colspan="2">
                    <div class="step"><span class="step-number">29b.</span> <b>create_archive_metadata()</b></div>
                    <div class="step">└─ {disc_label}.nfo</div>
                    <div class="step">└─ {disc_label}-thumb.jpg (falls TMDB)</div>
                    <div class="step"><b>NFO-Inhalt:</b></div>
                    <div class="step">└─ TITLE, DATE, TYPE</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="step"><span class="step-number">29c.</span> <b>Keine Archiv-Metadata</b></div>
                    <div class="step">└─ Nur ISO + MD5</div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(Cleanup)</td>
                <td class="audio-cd">
                    <div class="step"><span class="step-number">30a.</span> <b>rm -rf /tmp/artist/album/</b></div>
                    <div class="step"><span class="step-number">31a.</span> <b>rm cover.jpg</b></div>
                </td>
                <td class="dvd-video" colspan="2">
                    <div class="note">Cleanup bereits in Schritt 25b</div>
                </td>
                <td class="data-disc" colspan="3">
                    <div class="step"><span class="step-number">30b.</span> <b>rm /tmp/ddrescue.log</b></div>
                </td>
            </tr>
            <tr>
                <td class="state">COPYING<br>(Abschluss)</td>
                <td class="audio-cd" colspan="6">
                    <div class="step"><span class="step-number">32.</span> <b>finish_copy_log()</b></div>
                    <div class="step"><span class="step-number">33.</span> <b>API-Update: status = "completed"</b></div>
                    <div class="step"><span class="step-number">34.</span> <b>MQTT: mqtt_publish_complete() (optional)</b></div>
                    <div class="step"><span class="step-number">35.</span> <b>cleanup_disc_operation("success")</b></div>
                </td>
            </tr>

            <!-- PHASE 4: FINALISIERUNG -->
            <tr>
                <td class="phase-header" rowspan="3">Phase 4<br>Finalisierung</td>
                <td class="state">COMPLETED</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">36.</span> State-Übergang zu COMPLETED</div>
                    <div class="step"><span class="step-number">37.</span> Kurze Pause (3 Sekunden) - Status sichtbar machen</div>
                </td>
            </tr>
            <tr>
                <td class="state">WAITING_FOR_<br>REMOVAL</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">38.</span> Warte auf Medium-Entfernung</div>
                    <div class="step"><span class="step-number">39.</span> Polling: is_disc_inserted() (Intervall: 5 Sekunden)</div>
                    <div class="duration">Dauer: Bis Medium entfernt</div>
                </td>
            </tr>
            <tr>
                <td class="state">IDLE</td>
                <td colspan="6">
                    <div class="step"><span class="step-number">40.</span> Medium entfernt</div>
                    <div class="step"><span class="step-number">41.</span> State-Übergang zu WAITING_FOR_MEDIA (zurück zu Schritt 8)</div>
                    <div class="step"><span class="step-number">42.</span> Bereit für nächstes Medium</div>
                </td>
            </tr>
        </tbody>
    </table>

    <h2>Ausgabe-Dateien (OUTPUT_DIR)</h2>
    
    <table>
        <thead>
            <tr>
                <th>Disc-Typ</th>
                <th>Ausgabe-Ordner</th>
                <th>Dateien</th>
                <th>Beschreibung</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="audio-cd"><b>Audio-CD</b></td>
                <td>OUTPUT_DIR/audio/</td>
                <td>
                    <div class="output-files">artist_album.iso</div>
                    <div class="output-files">artist_album.md5</div>
                    <div class="output-files">artist_album.log</div>
                    <div class="output-files">artist_album.nfo</div>
                    <div class="output-files">artist_album-thumb.jpg</div>
                </td>
                <td>
                    <div>ISO mit MP3s + Jellyfin-Struktur</div>
                    <div>MD5-Checksumme</div>
                    <div>cdparanoia + lame Output</div>
                    <div>Archiv-Metadaten (einfach)</div>
                    <div>Cover-Thumbnail</div>
                </td>
            </tr>
            <tr>
                <td class="dvd-video"><b>DVD-Video</b></td>
                <td>OUTPUT_DIR/dvd/</td>
                <td>
                    <div class="output-files">disc_label.iso</div>
                    <div class="output-files">disc_label.md5</div>
                    <div class="output-files">disc_label.log</div>
                    <div class="output-files">disc_label.nfo</div>
                    <div class="output-files">disc_label-thumb.jpg</div>
                </td>
                <td>
                    <div>ISO mit VIDEO_TS/ (entschlüsselt)</div>
                    <div>MD5-Checksumme</div>
                    <div>dvdbackup + genisoimage Output</div>
                    <div>Archiv-Metadaten (falls TMDB)</div>
                    <div>Cover (falls TMDB)</div>
                </td>
            </tr>
            <tr>
                <td class="bd-video"><b>Blu-ray Video</b></td>
                <td>OUTPUT_DIR/bluray/</td>
                <td>
                    <div class="output-files">disc_label.iso</div>
                    <div class="output-files">disc_label.md5</div>
                    <div class="output-files">disc_label.log</div>
                    <div class="output-files">disc_label.nfo</div>
                </td>
                <td>
                    <div>ISO mit BDMV/ (Bit-für-Bit Kopie)</div>
                    <div>MD5-Checksumme</div>
                    <div>ddrescue Output</div>
                    <div>Archiv-Metadaten (falls TMDB)</div>
                </td>
            </tr>
            <tr>
                <td class="data-disc"><b>Daten-Disc</b></td>
                <td>OUTPUT_DIR/data/</td>
                <td>
                    <div class="output-files">disc_label.iso</div>
                    <div class="output-files">disc_label.md5</div>
                    <div class="output-files">disc_label.log</div>
                </td>
                <td>
                    <div>ISO (Bit-für-Bit Kopie)</div>
                    <div>MD5-Checksumme</div>
                    <div>ddrescue oder dd Output</div>
                </td>
            </tr>
        </tbody>
    </table>

    <h2>Zeitaufwand pro Disc-Typ</h2>
    
    <table>
        <thead>
            <tr>
                <th>Disc-Typ</th>
                <th>Medienerkennung</th>
                <th>Metadata-Abfrage</th>
                <th>User-Auswahl (max)</th>
                <th>Kopiervorgang</th>
                <th>MD5-Checksumme</th>
                <th>Gesamt (min)</th>
                <th>Gesamt (max)</th>
            </tr>
        </thead>
        <tbody>
            <tr class="audio-cd">
                <td><b>Audio-CD (12 Tracks)</b></td>
                <td>2-5s</td>
                <td>5-10s</td>
                <td>0-60s</td>
                <td>40-60 Min</td>
                <td>30s-2 Min</td>
                <td>~44 Min</td>
                <td>~63 Min</td>
            </tr>
            <tr class="dvd-video">
                <td><b>DVD-Video</b></td>
                <td>5-10s</td>
                <td>5-10s</td>
                <td>0-60s</td>
                <td>15-30 Min</td>
                <td>1-3 Min</td>
                <td>~17 Min</td>
                <td>~34 Min</td>
            </tr>
            <tr class="bd-video">
                <td><b>Blu-ray Video</b></td>
                <td>10-15s</td>
                <td>5-10s</td>
                <td>0-60s</td>
                <td>30-90 Min</td>
                <td>3-10 Min</td>
                <td>~34 Min</td>
                <td>~102 Min</td>
            </tr>
            <tr class="data-disc">
                <td><b>Daten-Disc (CD-ROM)</b></td>
                <td>2-5s</td>
                <td>-</td>
                <td>-</td>
                <td>5-10 Min</td>
                <td>10s-1 Min</td>
                <td>~6 Min</td>
                <td>~12 Min</td>
            </tr>
        </tbody>
    </table>

    <h2>API-Integration</h2>
    
    <table>
        <thead>
            <tr>
                <th>API-Datei</th>
                <th>Update-Punkte</th>
                <th>Inhalt</th>
                <th>Konsument</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><b>api/status.json</b></td>
                <td>Jeder State-Übergang (transition_to_state)</td>
                <td>status, disc_label, disc_type, timestamp</td>
                <td>Frontend (Echtzeit-Status)</td>
            </tr>
            <tr>
                <td><b>api/progress.json</b></td>
                <td>Während COPYING (Track- oder MB-basiert)</td>
                <td>percent, current, total, eta, timestamp</td>
                <td>Frontend (Fortschrittsbalken)</td>
            </tr>
            <tr>
                <td><b>api/attributes.json</b></td>
                <td>Start COPYING (init_copy_log)</td>
                <td>disc_label, disc_type, copy_method, total_tracks, iso_filename</td>
                <td>Frontend (Detailansicht)</td>
            </tr>
            <tr>
                <td><b>api/musicbrainz_releases.json</b></td>
                <td>Bei mehreren MusicBrainz Releases</td>
                <td>disc_id, track_count, releases[] (id, title, artist, date, cover_url)</td>
                <td>Python-Frontend (Release-Auswahl-Modal)</td>
            </tr>
            <tr>
                <td><b>api/musicbrainz_selection.json</b></td>
                <td>User-Auswahl oder Timeout</td>
                <td>status, selected_index, confidence, message, timestamp</td>
                <td>Bash (wait_for_metadata_selection)</td>
            </tr>
            <tr>
                <td><b>api/tmdb_results.json</b></td>
                <td>Bei mehreren TMDB Treffern</td>
                <td>disc_id, results[] (id, title, release_date, poster_path)</td>
                <td>Python-Frontend (Film-Auswahl-Modal)</td>
            </tr>
            <tr>
                <td><b>api/history.json</b></td>
                <td>Bei COMPLETED (cleanup_disc_operation)</td>
                <td>history[] (timestamp, disc_label, disc_type, iso_filename, success)</td>
                <td>Frontend (Verlauf-Tab)</td>
            </tr>
        </tbody>
    </table>

    <h2>Kritische Entscheidungspunkte</h2>
    
    <table>
        <thead>
            <tr>
                <th>Entscheidung</th>
                <th>Trigger</th>
                <th>Optionen</th>
                <th>Auswahl-Logik</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><b>Metadata BEFORE vs AFTER Copy</b></td>
                <td>Audio-CD erkannt</td>
                <td>
                    <div>1. BEFORE: User-Auswahl vor Rippen</div>
                    <div>2. AFTER: Rippen sofort, Metadata später</div>
                </td>
                <td>
                    <div><b>Aktuelle Strategie: BEFORE</b></div>
                    <div>✅ Disc-Label sofort korrekt</div>
                    <div>✅ MP3-Dateinamen mit Track-Titel</div>
                    <div>✅ Jellyfin-Struktur: /Artist/Album/</div>
                    <div>⚠️ User-Wartezeit vor Kopiervorgang</div>
                </td>
            </tr>
            <tr>
                <td><b>DVD: dvdbackup vs ddrescue</b></td>
                <td>DVD-Video erkannt</td>
                <td>
                    <div>1. dvdbackup: CSS-Entschlüsselung</div>
                    <div>2. ddrescue: Bit-für-Bit Kopie</div>
                </td>
                <td>
                    <div><b>select_copy_method():</b></div>
                    <div>✅ dvdbackup: Wenn libdvdcss verfügbar</div>
                    <div>⚠️ ddrescue: Fallback (kein CSS-Support)</div>
                    <div>⛔ Kein automatischer Fallback bei Fehler</div>
                </td>
            </tr>
            <tr>
                <td><b>Blu-ray: ddrescue vs dd</b></td>
                <td>BD-Video erkannt</td>
                <td>
                    <div>1. ddrescue: Robustes Kopieren</div>
                    <div>2. dd: Einfaches Kopieren</div>
                </td>
                <td>
                    <div><b>select_copy_method():</b></div>
                    <div>✅ ddrescue: Bevorzugt (Skip bei Lesefehlern)</div>
                    <div>⚠️ dd: Fallback (bricht bei Fehlern ab)</div>
                </td>
            </tr>
            <tr>
                <td><b>Fortschritts-Tracking</b></td>
                <td>COPYING State</td>
                <td>
                    <div>1. Track-basiert (Audio-CD)</div>
                    <div>2. MB-basiert (DVD/BD)</div>
                </td>
                <td>
                    <div><b>Audio-CD:</b> current = Track-Nummer (5/12)</div>
                    <div><b>DVD/BD:</b> current = Copied MB (4800/7050)</div>
                    <div>ETA: Geschätzt (4 Min/Track oder MB/s)</div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="note">
        <h3>Hinweise</h3>
        <ul>
            <li><b>Metadata BEFORE Copy:</b> Seit Version 1.2.0 Standard-Strategie für Audio-CDs. User-Auswahl erfolgt VOR dem Rippen (max 60s Timeout).</li>
            <li><b>Kein Fallback:</b> copy_disc_to_iso() hat KEINEN automatischen Fallback bei Fehler. Gewählte Methode wird einmal versucht.</li>
            <li><b>Track-Count wichtig:</b> Muss VOR api_update_progress() in attributes.json gesetzt sein (sonst 0/0 Anzeige).</li>
            <li><b>Python-Integration:</b> ISO-Mounting & MP3-Counting noch in Python (www/app.py). Migration geplant (siehe PythonVsShell.md).</li>
            <li><b>State Machine:</b> Läuft endlos (24/7-Betrieb). Nach COMPLETED → WAITING_FOR_REMOVAL → IDLE → WAITING_FOR_MEDIA (Loop).</li>
        </ul>
    </div>

    <footer style="margin-top: 40px; padding: 20px; background-color: #34495e; color: white; text-align: center;">
        <p><b>disk2iso Prozessanalyse</b> - Erstellt: 28. Januar 2026</p>
        <p>GitHub Copilot (Claude Sonnet 4.5) - Automatisch generiert aus Codebase-Analyse</p>
    </footer>
</body>
</html>
